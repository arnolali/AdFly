var _g=globals={},app=app||{};app=function(pCulture,pRoot){var self=this;self.culture=pCulture,self.root=pRoot,self.category="deals",self.format="480x325",self.step=1,self.offersNbr=0,self.gallery=!1,self.opts,$.getJSON(self.root+"public/data/translations.json",function(data){self.t=data,self.map_(),self.init_(),self.bindEvents_()}).error(function(){console.log("Erreur chargement des traduction!")})},app.prototype.map_=function(){var self=this;self.dom={b:$("body"),f:$(".js-form"),steps:$(".steps"),step1:$(".step.no1"),step2:$(".step.no2"),step3:$(".step.no3"),previousStep:$(".js-previousStep"),nextStep:$(".js-nextStep"),submit:$(".js-submit"),offersNbr:$('[name="offersNbr"]'),addOfferBtn:$(".addOffer"),addOfferMsg:$(".addOfferMsg"),offersList:$(".offersList"),render:$("iframe.render"),zipable:$("iframe.zipable"),downloadBtn:$(".js-download"),popupConfirmation:$(".popup.confirmation"),cancel:$(".popup.confirmation .js-cancel"),confirmBtn:$(".popup.confirmation .js-confirm"),popupDelete:$(".popup.delete"),cancelErease:$(".popup.delete .js-cancel"),confirmErease:$(".popup.delete .js-confirm"),field:{id:$('[name="id"]'),offersId:$('[name="offersId"]'),noClient:$('[name="noClient"]'),noAd:$('[name="noAd"]'),category:$('[name="category"]'),date:$('[name="date"]'),formatRadio:$(".row.format input"),format:$(".row.format .radio"),iConfirm:$('[name="iConfirm"]')}},self.path={images:"public/images/",templates:"public/templates/"}},app.prototype.init_=function(){var self=this;self.id=(new Date).getTime()+Math.floor(10*Math.random()),self.dom.field.id.val(self.id),jQuery.extend(jQuery.validator.messages,{required:' <span class="msg">('+self.t[self.culture].requiredField+")</span>",maxlength:jQuery.validator.format(' <span class="msg">('+self.t[self.culture].maxlength+")</span>")}),$.validator.addMethod("time",function(value,element){return this.optional(element)||/^(([0-1]?[0-9])|([2][0-3])):([0-5]?[0-9])?$/i.test(value)},"Please enter a valid time."),self.validator=self.dom.f.validate({debug:!0,errorPlacement:function(error,element){error.appendTo(element.closest(".field").find(".lbl"))},highlight:function(element){$(element).closest(".field").addClass("error").removeClass("valid")},unhighlight:function(element){$(element).closest(".field").addClass("valid").removeClass("error")},rules:{noClient:{required:!0,minlength:6,maxlength:6},noAd:{minlength:7,maxlength:7},logo:{required:!0}},messages:{noClient:{minlength:' <span class="msg">('+self.t[self.culture].mustContain6digits+")</span>",maxlength:' <span class="msg">('+self.t[self.culture].mustContain6digits+")</span>"},noAd:{minlength:' <span class="msg">('+self.t[self.culture].mustContain7digits+")</span>",maxlength:' <span class="msg">('+self.t[self.culture].mustContain7digits+")</span>"}}}),self.dom.field.noClient.mask("000000"),self.dom.field.noAd.mask("0000000"),self.dom.field.formatRadio.each(function(){var radio=$(this),value=radio.val();radio.attr("checked")?(radio.hide(),radio.after($("<img src='"+self.path.images+"formats/"+value+".png' class='radio valid' />"))):(radio.hide(),radio.after($("<img src='"+self.path.images+"formats/"+value+".png' class='radio'  />")))}),self.verticalAlign_($(".step.no1 .content"))},app.prototype.bindEvents_=function(){var self=this;self.dom.addOfferBtn.on("click",function(e){e.preventDefault(),self.setOffer_(500)}),self.dom.nextStep.on("click",function(){self.changeStep_(1)}),self.dom.previousStep.on("click",function(){self.changeStep_(-1)}),self.dom.submit.on("click",function(){}),self.dom.step1.on("click",".radio",function(){self.radioChoice=$(this),self.checkOffers_()}),self.dom.field.category.on("change",function(){self.category=$(this).val()}),self.dom.field.category.on("focus",function(){self.checkOffers_($(this)),elem=$(this)}),self.dom.steps.on("focus",'[name$="_freetext"]',function(){console.log("oui"),$(this).prev("label").children("input").prop("checked",!0)}),self.dom.steps.on("change",".file-input",function(){self.updateInputFilePreview_($(this))}),self.dom.steps.on("click",".file-input",function(){$(this).wrap("<form id='hiddenForm' style='display:none'></div>"),$("#hiddenForm")[0].reset(),$(this).unwrap("<form id='hiddenForm'></div>")}),self.dom.steps.on("change",".multi-files input",function(){self.addMultiFiles_($(this))}),self.dom.steps.on("click",".js-erease",function(){self.deleteMultiFiles_($(this).closest("li").data("key"))}),self.dom.steps.on("change",".video input",function(){self.updateVideo_($(this))}),self.dom.steps.on("click",".js-erease-video",function(){self.deleteVideo_($(this).closest(".row").find("input"))}),self.dom.steps.on("click",".delete-offer a",function(e){e.preventDefault();var offer=$(this).closest("fieldset");self.deleteOffer_(offer)}),self.dom.downloadBtn.on("click",function(e){e.preventDefault(),self.dom.popupConfirmation.addClass("active")}),self.dom.cancel.on("click",function(e){e.preventDefault(),self.dom.popupConfirmation.removeClass("active")}),self.dom.field.iConfirm.on("change",function(){self.dom.downloadBtn.toggleClass("disabled")}),self.dom.confirmBtn.on("click",function(e){e.preventDefault(),self.downloadAd_()}),self.dom.cancelErease.on("click",function(e){e.preventDefault(),self.dom.field.category.show(),self.dom.popupDelete.removeClass("active")}),self.dom.confirmErease.on("click",function(e){e.preventDefault(),self.dom.field.category.show(),self.updateRadioFormat_(self.radioChoice),self.resetOffers_(),self.dom.popupDelete.removeClass("active")})},app.prototype.downloadAd_=function(){console.log("allo");var self=this,html=self.dom.zipable.contents().find("html")[0].outerHTML;$.ajax({type:"POST",url:self.root+"app/libraries/createFiles.php",data:{id:self.id,h:html},success:function(){console.log("success: create folder"),self.dom.popupConfirmation.removeClass("active");var folder="../../temps/"+self.id;$.ajax({type:"POST",url:self.root+"app/libraries/zipFolder.php",data:{folder:folder,name:"annonce"},success:function(){var url=self.root+"/temps/"+self.id+"/annonce.zip";$("<iframe />").css("display","none").bind("load",function(){this.src==url&&$(this).remove()}).attr("src",url).appendTo($(document.body)),console.log("success: zip")},error:function(){console.log("error: zip")}})},error:function(){console.log("error: create folder"),self.dom.popupConfirmation.removeClass("active")}})},app.prototype.updateVideo_=function(pInput){var row=pInput.closest(".row"),files=row.find(".files-list");pInput.blur(),""==pInput.val()?files.addClass("hide"):files.removeClass("hide")},app.prototype.deleteVideo_=function(pInput){var row=pInput.closest(".row"),files=row.find(".files-list");resetFormElement(pInput),files.addClass("hide"),row.find(".field").removeClass("valid"),pInput.blur()},app.prototype.changeStep_=function(pValue){var self=this,currentStep=$(".step.no"+self.step),valid=!0;if(1===pValue&&$(".js-validate",currentStep).each(function(i,v){valid=self.validator.element(v)&&valid}),valid){if(1==self.step)self.setStep2_(self.category,self.format),self.offersNbr||self.setOffer_(0);else if(2==self.step){var data=new FormData($("form")[0]);self.setAdPreview_(data)}self.step+=parseInt(pValue),self.dom.b.removeClass("no1 no2 no3").addClass("no"+self.step)}},app.prototype.checkOffers_=function(){var self=this,fieldsets=self.dom.offersList.children("fieldset");0!=fieldsets.length?(self.dom.field.category.hide(),self.dom.popupDelete.addClass("active")):(self.updateRadioFormat_(self.radioChoice),self.dom.field.category.show())},app.prototype.resetOffers_=function(){for(var self=this,fieldsets=self.dom.offersList.children("fieldset"),x=0;x<fieldsets.length;x++)key=fieldsets.eq(x),self.deleteOffer_(key);self.offersNbr=0,self.gallery=!1},app.prototype.setStep2_=function(pCategory){var self=this;$.ajax({url:self.root+"public/data/settings/default.json",async:!1,dataType:"json",success:function(data){$.ajax({url:self.root+"public/data/settings/"+self.format+".json",async:!1,dataType:"json",success:function(formatSettings){$.extend(data,formatSettings),"conferences"==pCategory&&(data.price=!1,data.date=!0),self.opts=data,console.log(self.opts)}})}})},app.prototype.setAdPreview_=function(pData){var self=this;$.ajax({type:"POST",url:self.root+"ad.php",data:pData,cache:!1,contentType:!1,processData:!1,success:function(data){self.dom.render.css({width:self.format.split("x")[0]+"px",height:self.format.split("x")[1]+"px"});var idoc=self.dom.render[0].contentDocument,zipable=self.dom.zipable[0].contentDocument;idoc.open(),idoc.write(data),idoc.close(),zipable.open(),zipable.write(data),zipable.close()},error:function(data){console.log("error"),console.log(data)}})},app.prototype.setOffer_=function(pDelay){var self=this;if(self.offersNbr<self.opts.maxOffers&&!self.gallery){var id=(new Date).getTime(),opts=self.opts;self.updateOffer_(id),self.dom.offersNbr.val(self.offersNbr),self.offersNbr>1&&(opts.maxPictures=1),self.addOffer_({id:id,t:self.t[self.culture],opt:opts},pDelay)}},app.prototype.addOffer_=function(pObj,pSpeed){var self=this;pSpeed=pSpeed?parseInt(pSpeed):0,$.get(self.path.templates+"form-offer-tpl.mustache.html",function(template){setTimeout(function(){self.dom.offersList.append(Mustache.render($(template).filter("#formOfferTpl").html(),pObj)),$("textarea[name='"+pObj.id+"_title']").rules("add",{required:!0}),1==pObj.opt.price&&(self.dom.f.find("input[name='"+pObj.id+"_price']").rules("add",{required:!0}),$("input[name='"+pObj.id+"_price']").mask("99999")),1==pObj.opt.date&&(self.dom.f.find("input[name='"+pObj.id+"_date']").rules("add",{required:!0,date:!0,messages:{date:' <span class="msg">('+self.t[self.culture].enterValidDate+")"}}),$("input[name='"+pObj.id+"_date']").mask("0000-09-09"),self.dom.f.find("input[name='"+pObj.id+"_time']").rules("add",{required:!0,time:!0,messages:{time:' <span class="msg">('+self.t[self.culture].enterValidHour+")"}}),$("input[name='"+pObj.id+"_time']").mask("09:00")),$("."+pObj.id+"_rateit").rateit({max:5,step:1,backingfld:"#"+pObj.id+"_rateit_val"}),$("input[name='"+pObj.id+"_link']").rules("add",{required:!0,url:!0,messages:{url:' <span class="msg">('+self.t[self.culture].enterValidURL+")"}}),1==pObj.opt.description&&$("textarea[name='"+pObj.id+"_description']").rules("add",{required:!0}),self.initMultiFiles_($('input[name="'+pObj.id+'_picture[]"]')),setTimeout(function(){self.dom.offersList.find("fieldset:last").addClass("created")},50),self.updateMultifiles_()},pSpeed)})},app.prototype.deleteOffer_=function(pOffer){console.log("delete OUI");var self=this,id=pOffer.data("id");pOffer.remove(),self.updateOffer_(id),self.updateAddOfferBtn_()},app.prototype.updateOffer_=function(pId){{var self=this,currVal=self.dom.field.offersId.val(),arrIds=""===currVal?[]:currVal.split(","),strIds="",index=arrIds.indexOf(pId.toString());$(".multi-files .btn")}-1===index?(arrIds.push(pId),self.offersNbr++):(arrIds.splice(index,1),self.offersNbr--),strIds=arrIds.toString(),self.updateMultifiles_(),self.updateAddOfferBtn_(),self.updateOffersList_(),self.dom.offersNbr.val(self.offersNbr),self.dom.field.offersId.val(strIds)},app.prototype.updateAddOfferBtn_=function(){var self=this;self.offersNbr===self.opts.maxOffers?(self.dom.addOfferBtn.addClass("disabled"),self.dom.addOfferMsg.html("("+self.t[self.culture].offersMaxReached+")")):self.gallery?(self.dom.addOfferBtn.addClass("disabled"),self.dom.addOfferMsg.html("("+self.t[self.culture].cantAddOfferIfMoreThan1picture+")")):(self.dom.addOfferBtn.removeClass("disabled"),self.dom.addOfferMsg.html(""))},app.prototype.updateOffersList_=function(){var self=this,content=self.dom.step2.find(".content");self.dom.b.width()>1020&&(self.offersNbr>1?content.addClass("extend"):content.removeClass("extend"))},app.prototype.initMultiFiles_=function(pInput){pInput.closest(".field").wrap('<div class="multi-files"></div>'),pInput.closest(".multi-files").append('<ol class="files-list"></ol>')},app.prototype.deleteMultiFiles_=function(pKey){var self=this,input=$('input[data-key="'+pKey+'"]'),li=$('li[data-key="'+pKey+'"]'),ol=li.parent(),field=input.closest(".field"),lbl=field.find(".lbl"),msg=lbl.find(".msg"),btn=input.closest(".btn"),txt=btn.children(".text");btn.removeClass("disabled"),li.remove(),input.remove(),0===ol.children().length?(field.removeClass("valid").addClass("error"),msg.html("("+self.t[self.culture].requiredField+")"),txt.html(self.t[self.culture].uploadImage)):(self.gallery=1===ol.children().length?!1:!0,msg.html(""),txt.html(self.t[self.culture].uploadOtherImages)),self.updateAddOfferBtn_()},app.prototype.addMultiFiles_=function(pInput){var self=this;self.getUploadedImageObj_(pInput,function(pImg){var field=pInput.closest(".field"),name=(field.find(".lbl"),pInput.attr("name")),btn=pInput.closest(".btn"),txt=btn.children(".text"),list=pInput.closest(".multi-files").find(".files-list"),key=pInput.data("key"),max=parseInt(btn.data("max")),obj={key:key,img:pImg};list.children().length<max&&$.get(self.path.templates+"file-preview-tpl.mustache.html",function(template){var newKey=(new Date).getTime();list.append(Mustache.render($(template).filter("#filePreviewTpl").html(),obj)),txt.html(self.t[self.culture].uploadOtherImages),btn.append('<input type="file" accept="image/*" capture="camera" name="'+name+'" data-key="'+newKey+'" />'),self.gallery=list.children().length>1?!0:!1,self.updateAddOfferBtn_(),self.updateMultifiles_()}),pInput.addClass("hide").blur()})},app.prototype.updateMultifiles_=function(){for(var self=this,multifiles=$(".multi-files"),btns=multifiles.find(".btn"),x=0;x<multifiles.length;x++){var msg=multifiles.eq(x).find(".msg"),btn=btns.eq(x),txt=btn.find(".text"),list=multifiles.eq(x).find(".files-list"),max=multifiles.length>1?1:btns.eq(x).data("max-original");btn.data("max",max),0==list.children().length?(btn.removeClass("disabled"),msg.html(""),txt.html(self.t[self.culture].uploadImage)):list.children().length<btn.data("max")?(btn.removeClass("disabled"),msg.html(""),txt.html(self.t[self.culture].uploadOtherImages)):(btn.addClass("disabled"),msg.html(' <span class="msg">('+self.t[self.culture].maximumPicturesNumberReached+")</span>"),txt.html(self.t[self.culture].uploadImage))}},app.prototype.updateInputFilePreview_=function(pInput){var self=this;self.getUploadedImageObj_(pInput,function(pImg){var btn=pInput.closest(".btn"),field=btn.closest(".field"),preview=(field.find(".lbl"),btn.next(".preview"));preview.css({"background-image":"url("+pImg+")"}).addClass("active"),pInput.blur()})},app.prototype.getUploadedImageObj_=function(pInput,callback){var file=pInput.prop("files")[0],reader=new FileReader;reader.onload=function(e){$("<img/>").attr("src",e.target.result).load(function(){var img=e.target.result;callback(img)})},reader.readAsDataURL(file)},app.prototype.updateRadioFormat_=function(pRadio){var self=this;pRadio.parent().find(".valid").removeClass("valid").prev().removeAttr("checked"),pRadio.addClass("valid").prev().attr("checked","true"),self.format=pRadio.prev().val(),self.dom.offersList.find("fieldset").remove(),self.dom.step2.find(".content").removeClass("extend"),self.offersNbr=0,self.dom.offersNbr.val(self.offersNbr)},app.prototype.verticalAlign_=function(pElem){var self=this,h=pElem.children("fieldset").height(),browserH=self.dom.steps.height(),posY=(browserH-h-100)/2;pElem.css("top",posY+"px")};