var _g=globals={},app=app||{};app=function(e,t){var s=this;s.culture=e,s.root=t,s.step=1,s.offersNbr=0,s.opts,$.getJSON(s.root+"public/data/translations.json",function(e){s.t=e,s.map_(),s.init_(),s.bindEvents_()}).error(function(){console.log("Erreur chargement des traduction!")})},app.prototype.map_=function(){var e=this;e.dom={b:$("body"),f:$(".js-form"),steps:$(".steps"),step1:$(".step.no1"),step2:$(".step.no2"),step3:$(".step.no3"),previousStep:$(".js-previousStep"),nextStep:$(".js-nextStep"),submit:$(".js-submit"),offersNbr:$('[name="offersNbr"]'),addOffer:$(".addOffer"),offersList:$(".offersList"),field:{noClient:$('[name="noClient"]'),noAd:$('[name="noAd"]'),category:$('[name="category"]'),date:$('[name="date"]'),formatRadio:$(".row.format input"),format:$(".row.format .radio")}},e.path={images:"public/images/",templates:"public/templates/"}},app.prototype.init_=function(){var e=this;e.validator=e.dom.f.validate({debug:!0,errorPlacement:function(e,t){e.appendTo(t.closest(".field").find(".lbl"))},highlight:function(e){$(e).closest(".field").addClass("error").removeClass("valid")},unhighlight:function(e){$(e).closest(".field").addClass("valid").removeClass("error")},rules:{noClient:{required:!0,minlength:6,maxlength:6},noAd:{minlength:7,maxlength:7},logo:{required:!0}},messages:{noClient:{required:' <span class="msg">('+e.t[e.culture].requiredField+")</span>",minlength:' <span class="msg">('+e.t[e.culture].mustContain6digits+")</span>",maxlength:' <span class="msg">('+e.t[e.culture].mustContain6digits+")</span>"},noAd:{minlength:' <span class="msg">('+e.t[e.culture].mustContain7digits+")</span>",maxlength:' <span class="msg">('+e.t[e.culture].mustContain7digits+")</span>"},logo:{required:' <span class="msg">('+e.t[e.culture].requiredField+")</span>"}}}),e.dom.field.noClient.mask("000000"),e.dom.field.noAd.mask("0000000"),e.dom.field.formatRadio.each(function(){var t=$(this),s=t.val();t.attr("checked")?(t.hide(),t.after($("<img src='"+e.path.images+"formats/"+s+".png' class='radio valid' />"))):(t.hide(),t.after($("<img src='"+e.path.images+"formats/"+s+".png' class='radio'  />")))}),e.verticalAlign_($(".step.no1 .content"))},app.prototype.bindEvents_=function(){var e=this;e.dom.addOffer.on("click",function(t){t.preventDefault(),e.setNewOffer_()}),e.dom.nextStep.on("click",function(){e.changeStep_(1)}),e.dom.previousStep.on("click",function(){e.changeStep_(-1)}),e.dom.submit.on("click",function(){}),e.dom.step1.on("click",".radio",function(){e.updateRadioFormat_($(this))}),e.dom.steps.on("change",".file-input",function(){e.updateInputFilePreview_($(this))}),e.dom.steps.on("change",".multi-files input",function(){e.updateMultiFilesPreview_($(this))}),e.dom.steps.on("click",".js-erease",function(){e.ereaseInput_($(this).closest("li").data("key"))}),e.dom.steps.on("click",".delete-offer a",function(t){t.preventDefault();var s=$(this).closest("fieldset");e.deleteOffer_(s)})},app.prototype.changeStep_=function(e){var t=this,s=$(".step.no"+t.step),a=!0;if(1===e&&$(".js-validate",s).each(function(e,s){a=t.validator.element(s)&&a}),1==t.step&&a&&0==t.offersNbr&&(t.opts=t.setTemplateOptions_(t.dom.field.category.val(),$(".row.format input:checked").val()),t.addOffer_({id:t.offersNbr+1,t:t.t[t.culture],opt:t.opts}),t.offersNbr++,t.dom.offersNbr.val(t.offersNbr)),2==t.step&&a){var i=$("form").serializeObject();console.dir(i),t.dom.step3.text(JSON.stringify(i))}a&&(t.step+=parseInt(e),t.dom.b.removeClass("no1 no2 no3").addClass("no"+t.step))},app.prototype.setNewOffer_=function(){var e=this;e.offersNbr<e.opts.maxOffers&&(e.offersNbr++,e.dom.offersNbr.val(e.offersNbr),e.addOffer_({id:e.offersNbr+1,t:e.t[e.culture],opt:e.opts},500),e.dom.b.width()>1020&&e.dom.step2.find(".content").addClass("extend"),e.offersNbr===e.opts.maxOffers&&e.dom.addOffer.addClass("disabled"))},app.prototype.deleteOffer_=function(e){var t=this;t.offersNbr--,t.dom.offersNbr.val(t.offersNbr),e.remove(),t.dom.addOffer.removeClass("disabled"),1==t.dom.offersList.children("fieldset").length&&t.dom.step2.find(".content").removeClass("extend")},app.prototype.ereaseInput_=function(e){var t=$('input[data-key="'+e+'"]'),s=t.closest(".field"),a=s.find(".lbl"),i=a.find(".msg"),r=t.closest(".btn");r.removeClass("disabled"),i.html(""),$('[data-key="'+e+'"]').remove()},app.prototype.setTemplateOptions_=function(e,t){var s={price:!0,date:!1,maxOffers:2,picture:!0,maxPictures:2,video:!1};return"conferences"==e&&(s.price=!1,s.date=!0),"480x324"==t?(s.maxOffers=4,s.maxPictures=4,s.video=!0):"480x152"==t?(s.maxOffers=2,s.maxPictures=2):"230x324"==t?(s.maxOffers=2,s.maxPictures=2):"230x152"==t&&(s.picture=!1,s.maxOffers=1,s.maxPictures=0),s},app.prototype.updateInputFilePreview_=function(e){var t=this;t.getUploadedImageObj_(e,function(t){var s=e.closest(".btn"),a=s.closest(".field"),i=(a.find(".lbl"),s.next(".preview"));i.css({"background-image":"url("+t+")"}).addClass("active"),e.blur()})},app.prototype.updateMultiFilesPreview_=function(e){var t=this;t.getUploadedImageObj_(e,function(s){var a=e.closest(".field"),i=a.find(".lbl"),r=e.attr("name"),n=e.closest(".btn"),o=e.closest(".multi-files").find(".files-list"),d=e.data("key"),l=parseInt(n.data("max")),p={key:d,img:s};o.children().length<l&&$.get(t.path.templates+"file-preview-tpl.mustache.html",function(e){o.append(Mustache.render($(e).filter("#filePreviewTpl").html(),p));var s=(new Date).getTime();n.append('<input type="file" name="'+r+'" data-key="'+s+'" />'),o.children().length==l&&(i.find(".msg").length?i.find(".msg").html('<span class="msg">('+t.t[t.culture].maximumPicturesNumberReached+")</span>"):i.append(' <span class="msg">('+t.t[t.culture].maximumPicturesNumberReached+")</span>"),n.addClass("disabled"))}),e.addClass("hide").blur()})},app.prototype.getUploadedImageObj_=function(e,t){var s=e.prop("files")[0],a=new FileReader;a.onload=function(e){$("<img/>").attr("src",e.target.result).load(function(){var s=e.target.result;t(s)})},a.readAsDataURL(s)},app.prototype.updateRadioFormat_=function(e){var t=this;e.parent().find(".valid").removeClass("valid").prev().removeAttr("checked"),e.addClass("valid").prev().attr("checked","true"),t.dom.offersList.find("fieldset").remove(),t.dom.step2.find(".content").removeClass("extend"),t.offersNbr=0,t.dom.offersNbr.val(t.offersNbr)},app.prototype.addOffer_=function(e,t){var s=this;t=t?parseInt(t):0,$.get(s.path.templates+"screen-tpl.mustache.html",function(a){setTimeout(function(){s.dom.offersList.append(Mustache.render($(a).filter("#screenTpl").html(),e)),$("input[name='"+e.id+"_destination']").rules("add",{required:!0,messages:{required:' <span class="msg">('+s.t[s.culture].requiredField+")"}}),$("input[name='"+e.id+"_moreDestination']").rules("add",{required:!0,messages:{required:' <span class="msg">('+s.t[s.culture].requiredField+")"}}),1==e.opt.price&&s.dom.f.find("input[name='"+e.id+"_price']").rules("add",{required:!0,messages:{required:' <span class="msg">('+s.t[s.culture].requiredField+")"}}),$("input[name='"+e.id+"_price']").mask("99999"),1==e.opt.date&&s.dom.f.find("input[name='"+e.id+"_date']").rules("add",{required:!0,date:!0,messages:{required:' <span class="msg">('+s.t[s.culture].requiredField+")",date:' <span class="msg">('+s.t[s.culture].enterValidDate+")"}}),$("input[name='"+e.id+"_date']").mask("0000-09-09"),$("input[name='"+e.id+"_link']").rules("add",{required:!0,url:!0,messages:{required:' <span class="msg">('+s.t[s.culture].requiredField+")",url:' <span class="msg">('+s.t[s.culture].enterValidURL+")"}}),$("textarea[name='"+e.id+"_description']").rules("add",{required:!0,messages:{required:' <span class="msg">('+s.t[s.culture].requiredField+")"}}),s.createMultiFiles_($('input[name="'+e.id+'_picture[]"]')),setTimeout(function(){s.dom.offersList.find("fieldset:last").addClass("created")},50)},t)})},app.prototype.createMultiFiles_=function(e){e.closest(".field").wrap('<div class="multi-files"></div>'),e.closest(".multi-files").append('<ol class="files-list"></ol>')},app.prototype.verticalAlign_=function(e){var t=this,s=e.height(),a=t.dom.steps.height(),i=(a-s-100)/2;e.css("top",i+"px")};