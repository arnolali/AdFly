var _g=globals={},app=app||{};app=function(e,t){var a=this;a.culture=e,a.root=t,a.category="deals",a.format="480x325",a.step=1,a.offersNbr=0,a.gallery=!1,a.opts,$.getJSON(a.root+"public/data/translations.json",function(e){a.t=e,a.map_(),a.init_(),a.bindEvents_()}).error(function(){console.log("Erreur chargement des traduction!")})},app.prototype.map_=function(){var e=this;e.dom={b:$("body"),f:$(".js-form"),steps:$(".steps"),step1:$(".step.no1"),step2:$(".step.no2"),step3:$(".step.no3"),previousStep:$(".js-previousStep"),nextStep:$(".js-nextStep"),submit:$(".js-submit"),offersNbr:$('[name="offersNbr"]'),addOfferBtn:$(".addOffer"),addOfferMsg:$(".addOfferMsg"),offersList:$(".offersList"),render:$("iframe.render"),zipable:$("iframe.zipable"),downloadBtn:$(".js-download"),popupConfirmation:$(".popup.confirmation"),cancel:$(".js-cancel"),confirmBtn:$(".js-confirm"),field:{id:$('[name="id"]'),offersId:$('[name="offersId"]'),noClient:$('[name="noClient"]'),noAd:$('[name="noAd"]'),category:$('[name="category"]'),date:$('[name="date"]'),formatRadio:$(".row.format input"),format:$(".row.format .radio"),iConfirm:$('[name="iConfirm"]')}},e.path={images:"public/images/",templates:"public/templates/"}},app.prototype.init_=function(){var e=this;e.id=(new Date).getTime()+Math.floor(10*Math.random()),e.dom.field.id.val(e.id),jQuery.extend(jQuery.validator.messages,{required:' <span class="msg">('+e.t[e.culture].requiredField+")</span>",maxlength:jQuery.validator.format(' <span class="msg">('+e.t[e.culture].maxlength+")</span>")}),$.validator.addMethod("time",function(e,t){return this.optional(t)||/^(([0-1]?[0-9])|([2][0-3])):([0-5]?[0-9])?$/i.test(e)},"Please enter a valid time."),e.validator=e.dom.f.validate({debug:!0,errorPlacement:function(e,t){e.appendTo(t.closest(".field").find(".lbl"))},highlight:function(e){$(e).closest(".field").addClass("error").removeClass("valid")},unhighlight:function(e){$(e).closest(".field").addClass("valid").removeClass("error")},rules:{noClient:{required:!0,minlength:6,maxlength:6},noAd:{minlength:7,maxlength:7},logo:{required:!0}},messages:{noClient:{minlength:' <span class="msg">('+e.t[e.culture].mustContain6digits+")</span>",maxlength:' <span class="msg">('+e.t[e.culture].mustContain6digits+")</span>"},noAd:{minlength:' <span class="msg">('+e.t[e.culture].mustContain7digits+")</span>",maxlength:' <span class="msg">('+e.t[e.culture].mustContain7digits+")</span>"}}}),e.dom.field.noClient.mask("000000"),e.dom.field.noAd.mask("0000000"),e.dom.field.formatRadio.each(function(){var t=$(this),a=t.val();t.attr("checked")?(t.hide(),t.after($("<img src='"+e.path.images+"formats/"+a+".png' class='radio valid' />"))):(t.hide(),t.after($("<img src='"+e.path.images+"formats/"+a+".png' class='radio'  />")))}),e.verticalAlign_($(".step.no1 .content"))},app.prototype.bindEvents_=function(){var e=this;e.dom.addOfferBtn.on("click",function(t){t.preventDefault(),e.setOffer_(500)}),e.dom.nextStep.on("click",function(){e.changeStep_(1)}),e.dom.previousStep.on("click",function(){e.changeStep_(-1)}),e.dom.submit.on("click",function(){}),e.dom.step1.on("click",".radio",function(){e.updateRadioFormat_($(this))}),e.dom.field.category.on("change",function(){e.category=$(this).val(),e.resetOffers_()}),e.dom.steps.on("focus",'[name$="_freetext"]',function(){console.log("oui"),$(this).prev("label").children("input").prop("checked",!0)}),e.dom.steps.on("change",".file-input",function(){e.updateInputFilePreview_($(this))}),e.dom.steps.on("change",".multi-files input",function(){e.addMultiFiles_($(this))}),e.dom.steps.on("click",".js-erease",function(){e.deleteMultiFiles_($(this).closest("li").data("key"))}),e.dom.steps.on("change",".video input",function(){e.updateVideo_($(this))}),e.dom.steps.on("click",".js-erease-video",function(){e.deleteVideo_($(this).closest(".row").find("input"))}),e.dom.steps.on("click",".delete-offer a",function(t){t.preventDefault();var a=$(this).closest("fieldset");e.deleteOffer_(a)}),e.dom.downloadBtn.on("click",function(t){t.preventDefault(),e.dom.popupConfirmation.addClass("active")}),e.dom.cancel.on("click",function(t){t.preventDefault(),e.dom.popupConfirmation.removeClass("active")}),e.dom.field.iConfirm.on("change",function(){e.dom.downloadBtn.toggleClass("disabled")}),e.dom.confirmBtn.on("click",function(t){t.preventDefault(),e.downloadAd_()})},app.prototype.downloadAd_=function(){var e=this,t=e.dom.zipable.contents().find("html")[0].outerHTML;$.ajax({type:"POST",url:e.root+"app/libraries/createFiles.php",data:{id:e.id,h:t},success:function(){console.log("success: create folder"),e.dom.popupConfirmation.removeClass("active");var t="../../temps/"+e.id;$.ajax({type:"POST",url:e.root+"app/libraries/zipFolder.php",data:{folder:t,name:"annonce"},success:function(){var t=e.root+"/temps/"+e.id+"/annonce.zip";$("<iframe />").css("display","none").bind("load",function(){this.src==t&&$(this).remove()}).attr("src",t).appendTo($(document.body)),console.log("success: zip")},error:function(){console.log("error: zip")}})},error:function(){console.log("error: create folder"),e.dom.popupConfirmation.removeClass("active")}})},app.prototype.updateVideo_=function(e){var t=e.closest(".row"),a=t.find(".files-list");e.blur(),""==e.val()?a.addClass("hide"):a.removeClass("hide")},app.prototype.deleteVideo_=function(e){var t=e.closest(".row"),a=t.find(".files-list");resetFormElement(e),a.addClass("hide"),t.find(".field").removeClass("valid"),e.blur()},app.prototype.changeStep_=function(e){var t=this,a=$(".step.no"+t.step),o=!0;if(1===e&&$(".js-validate",a).each(function(e,a){o=t.validator.element(a)&&o}),o){if(1==t.step)t.setStep2_(t.category,t.format),t.offersNbr||t.setOffer_(0);else if(2==t.step){var i=new FormData($("form")[0]);t.setAdPreview_(i)}t.step+=parseInt(e),t.dom.b.removeClass("no1 no2 no3").addClass("no"+t.step)}},app.prototype.resetOffers_=function(){for(var e=this,t=e.dom.offersList.children("fieldset"),a=0;a<t.length;a++)key=t.eq(a),e.deleteOffer_(key);e.offersNbr=0,e.gallery=!1},app.prototype.setStep2_=function(e){var t=this;$.ajax({url:t.root+"public/data/settings/default.json",async:!1,dataType:"json",success:function(a){$.ajax({url:t.root+"public/data/settings/"+t.format+".json",async:!1,dataType:"json",success:function(o){$.extend(a,o),"conferences"==e&&(a.price=!1,a.date=!0),t.opts=a,console.log(t.opts)}})}})},app.prototype.setAdPreview_=function(e){var t=this;$.ajax({type:"POST",url:t.root+"ad.php",data:e,cache:!1,contentType:!1,processData:!1,success:function(e){t.dom.render.css({width:t.format.split("x")[0]+"px",height:t.format.split("x")[1]+"px"});var a=t.dom.render[0].contentDocument,o=t.dom.zipable[0].contentDocument;a.open(),a.write(e),a.close(),o.open(),o.write(e),o.close(),console.log("idoc",a),console.log("zipable",o)},error:function(e){console.log("error"),console.log(e)}})},app.prototype.setOffer_=function(e){var t=this;if(t.offersNbr<t.opts.maxOffers&&!t.gallery){var a=(new Date).getTime(),o=t.opts;t.updateOffer_(a),t.dom.offersNbr.val(t.offersNbr),t.offersNbr>1&&(o.maxPictures=1),t.addOffer_({id:a,t:t.t[t.culture],opt:o},e)}},app.prototype.addOffer_=function(e,t){var a=this;t=t?parseInt(t):0,$.get(a.path.templates+"form-offer-tpl.mustache.html",function(o){setTimeout(function(){a.dom.offersList.append(Mustache.render($(o).filter("#formOfferTpl").html(),e)),$("textarea[name='"+e.id+"_title']").rules("add",{required:!0}),1==e.opt.price&&(a.dom.f.find("input[name='"+e.id+"_price']").rules("add",{required:!0}),$("input[name='"+e.id+"_price']").mask("99999")),1==e.opt.date&&(a.dom.f.find("input[name='"+e.id+"_date']").rules("add",{required:!0,date:!0,messages:{date:' <span class="msg">('+a.t[a.culture].enterValidDate+")"}}),$("input[name='"+e.id+"_date']").mask("0000-09-09"),a.dom.f.find("input[name='"+e.id+"_time']").rules("add",{required:!0,time:!0,messages:{time:' <span class="msg">('+a.t[a.culture].enterValidHour+")"}}),$("input[name='"+e.id+"_time']").mask("09:00")),$("."+e.id+"_rateit").rateit({max:5,step:1,backingfld:"#"+e.id+"_rateit_val"}),$("input[name='"+e.id+"_link']").rules("add",{required:!0,url:!0,messages:{url:' <span class="msg">('+a.t[a.culture].enterValidURL+")"}}),1==e.opt.description&&$("textarea[name='"+e.id+"_description']").rules("add",{required:!0}),a.initMultiFiles_($('input[name="'+e.id+'_picture[]"]')),setTimeout(function(){a.dom.offersList.find("fieldset:last").addClass("created")},50),a.updateMultifiles_()},t)})},app.prototype.deleteOffer_=function(e){var t=this,a=e.data("id");e.remove(),t.updateOffer_(a),t.updateAddOfferBtn_()},app.prototype.updateOffer_=function(e){{var t=this,a=t.dom.field.offersId.val(),o=""===a?[]:a.split(","),i="",s=o.indexOf(e.toString());$(".multi-files .btn")}-1===s?(o.push(e),t.offersNbr++):(o.splice(s,1),t.offersNbr--),i=o.toString(),t.updateMultifiles_(),t.updateAddOfferBtn_(),t.updateOffersList_(),t.dom.offersNbr.val(t.offersNbr),t.dom.field.offersId.val(i)},app.prototype.updateAddOfferBtn_=function(){var e=this;e.offersNbr===e.opts.maxOffers?(e.dom.addOfferBtn.addClass("disabled"),e.dom.addOfferMsg.html("("+e.t[e.culture].offersMaxReached+")")):e.gallery?(e.dom.addOfferBtn.addClass("disabled"),e.dom.addOfferMsg.html("("+e.t[e.culture].cantAddOfferIfMoreThan1picture+")")):(e.dom.addOfferBtn.removeClass("disabled"),e.dom.addOfferMsg.html(""))},app.prototype.updateOffersList_=function(){var e=this,t=e.dom.step2.find(".content");e.dom.b.width()>1020&&(e.offersNbr>1?t.addClass("extend"):t.removeClass("extend"))},app.prototype.initMultiFiles_=function(e){e.closest(".field").wrap('<div class="multi-files"></div>'),e.closest(".multi-files").append('<ol class="files-list"></ol>')},app.prototype.deleteMultiFiles_=function(e){var t=this,a=$('input[data-key="'+e+'"]'),o=$('li[data-key="'+e+'"]'),i=o.parent(),s=a.closest(".field"),r=s.find(".lbl"),n=r.find(".msg"),d=a.closest(".btn"),l=d.children(".text");d.removeClass("disabled"),o.remove(),a.remove(),0===i.children().length?(s.removeClass("valid").addClass("error"),n.html("("+t.t[t.culture].requiredField+")"),l.html(t.t[t.culture].uploadImage)):(t.gallery=1===i.children().length?!1:!0,n.html(""),l.html(t.t[t.culture].uploadOtherImages)),t.updateAddOfferBtn_()},app.prototype.addMultiFiles_=function(e){var t=this;t.getUploadedImageObj_(e,function(a){var o=e.closest(".field"),i=(o.find(".lbl"),e.attr("name")),s=e.closest(".btn"),r=s.children(".text"),n=e.closest(".multi-files").find(".files-list"),d=e.data("key"),l=parseInt(s.data("max")),p={key:d,img:a};n.children().length<l&&$.get(t.path.templates+"file-preview-tpl.mustache.html",function(e){var a=(new Date).getTime();n.append(Mustache.render($(e).filter("#filePreviewTpl").html(),p)),r.html(t.t[t.culture].uploadOtherImages),s.append('<input type="file" accept="image/*" capture="camera" name="'+i+'" data-key="'+a+'" />'),t.gallery=n.children().length>1?!0:!1,t.updateAddOfferBtn_(),t.updateMultifiles_()}),e.addClass("hide").blur()})},app.prototype.updateMultifiles_=function(){for(var e=this,t=$(".multi-files"),a=t.find(".btn"),o=0;o<t.length;o++){var i=t.eq(o).find(".msg"),s=a.eq(o),r=s.find(".text"),n=t.eq(o).find(".files-list"),d=t.length>1?1:a.eq(o).data("max-original");s.data("max",d),0==n.children().length?(s.removeClass("disabled"),i.html(""),r.html(e.t[e.culture].uploadImage)):n.children().length<s.data("max")?(s.removeClass("disabled"),i.html(""),r.html(e.t[e.culture].uploadOtherImages)):(s.addClass("disabled"),i.html(' <span class="msg">('+e.t[e.culture].maximumPicturesNumberReached+")</span>"),r.html(e.t[e.culture].uploadImage))}},app.prototype.updateInputFilePreview_=function(e){var t=this;t.getUploadedImageObj_(e,function(t){var a=e.closest(".btn"),o=a.closest(".field"),i=(o.find(".lbl"),a.next(".preview"));i.css({"background-image":"url("+t+")"}).addClass("active"),e.blur()})},app.prototype.getUploadedImageObj_=function(e,t){var a=e.prop("files")[0],o=new FileReader;o.onload=function(e){$("<img/>").attr("src",e.target.result).load(function(){var a=e.target.result;t(a)})},o.readAsDataURL(a)},app.prototype.updateRadioFormat_=function(e){var t=this;t.resetOffers_(),e.parent().find(".valid").removeClass("valid").prev().removeAttr("checked"),e.addClass("valid").prev().attr("checked","true"),t.format=e.prev().val(),t.dom.offersList.find("fieldset").remove(),t.dom.step2.find(".content").removeClass("extend"),t.offersNbr=0,t.dom.offersNbr.val(t.offersNbr)},app.prototype.verticalAlign_=function(e){var t=this,a=e.children("fieldset").height(),o=t.dom.steps.height(),i=(o-a-100)/2;e.css("top",i+"px")};